{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Sample CloudFormation Template for CSYE 6225 - Fall 2017",
    "Resources": {
     
         "EC2Instance": {
            "Type": "AWS::EC2::Instance",
            "Metadata":{
              "AWS::CloudFormation::Init":{
                "configSets":{
                  "InstallAndRun":["Install","Configure"]
                },
                "Install":{
                  "packages":{
                    "apt-get":{
                      "java-1.8.0-openjdk":[],
                      "tomcat8":[],
                      "CodeDeployAgent":[]
                    }
                  },
                  "files":{}
                }
              }
            },
            "Properties": {
                "ImageId": "ami-cd0f5cb6",
                "InstanceType": "t2.micro",
                "SecurityGroupIds": [
                    {
                        "Fn::GetAtt": ["EC2InstanceSG","GroupId"]
                    }
                ],
                "KeyName": "MyKeyPair",
                "SubnetId":{"Ref":"ParamSubnetId1"},
                "Tags":[{"Key":"NAME","Value":"CSYE6225"}],
                "UserData":{
                  "Fn::Base64":{
                    "Fn::Join":["",[
                      "#!/bin/bash -v\n",
                      "sudo apt-get update\n",
                      "sudo apt install default-jre\n",

                      "# Install the files and packages from the metadata\n",
                      "/opt/aws/bin/cfn-init -v",
                      "--stack",{"Ref":"AWS::StackName"},
                      "--resource EC2Instance",
                      "--configSets InstallAndRun",
                      "--region",{"Ref":"AWS::Region"}, "\n",

                      "# Signal the status from cfn-init\n",
                      "/opt/aws/bin/cfn-signal -e $? ",
                      "--stack",{"Ref":"AWS::StackName"},
                      "--resource EC2Instance",
                      "--region",{"Ref":"AWS::Region"}, "\n"
                ]]}}
            },
           "CreationPolicy":{
             "ResourceSignal":{
               "Timeout":"PT5M"
             }
           }
        },    
        "EC2InstanceSG": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
            "GroupDescription": "Sample EC2Instabce security group",
            "GroupName":"csye6225-webapptest",
            "VpcId":{"Ref":"ParamVpcID"}
                          }
                         },
        
       "EC2InstanceSGInboundRule1": {
           "Type": "AWS::EC2::SecurityGroupIngress",
           "Properties":{
           "IpProtocol": "tcp",
           "FromPort": "22",
           "ToPort": "22",
           "CidrIp": "0.0.0.0/0",
           "GroupId": {"Fn::GetAtt": ["EC2InstanceSG", "GroupId"]}      
      }
    },
       "EC2InstanceSGInboundRule2": {
           "Type": "AWS::EC2::SecurityGroupIngress",
           "Properties":{
           "IpProtocol": "tcp",
           "FromPort": "80",
           "ToPort": "80",
           "CidrIp": "0.0.0.0/0",
           "GroupId": {"Fn::GetAtt": ["EC2InstanceSG", "GroupId"]}       
      }
    },
       "EC2InstanceSGInboundRule3": {
           "Type": "AWS::EC2::SecurityGroupIngress",
           "Properties":{
           "IpProtocol": "tcp",
           "FromPort": "443",
           "ToPort": "443",
           "CidrIp": "0.0.0.0/0",
           "GroupId": {"Fn::GetAtt": ["EC2InstanceSG", "GroupId"]}        
      }
    }
   },
    "Parameters" : {
          "ParamVpcID" : {
            "Type" : "String"
       },
          "ParamSubnetId1" : {
            "Type" : "String"
       }
          
    }
}
